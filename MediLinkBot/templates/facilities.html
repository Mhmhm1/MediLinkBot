<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nearby Health Facilities - MediLinkBot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f5f9ff; }
        #map { height: 420px; border-radius: 0.5rem; }
        .facility-item { cursor: pointer; }
        .facility-item:hover { background-color: #eef5ff; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Nearby Health Facilities</h2>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">Back to Home</a>
    </div>
    <p class="text-muted">
        Allow location access to see hospitals, clinics and pharmacies near you. This helps you reach real medical help quickly in case of illness or emergency.
    </p>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold">Map</span>
                        <button id="use-location" class="btn btn-primary btn-sm">Use My Location</button>
                    </div>
                    <div id="map"></div>
                    <small class="text-muted d-block mt-2">Map data © OpenStreetMap contributors</small>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="fw-semibold mb-2">Facilities List</h6>
                    <p id="status" class="text-muted small mb-2">Click "Use My Location" to begin.</p>
                    <div id="facilities-list" class="list-group small" style="max-height: 360px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info mt-4 mb-0">
        <strong>Note:</strong> MediLinkBot does not replace professional medical care. In an emergency, call your local emergency number immediately.
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map;
    let userMarker;
    let facilityMarkers = [];

    function initMap(lat, lng) {
        if (!map) {
            map = L.map('map').setView([lat, lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        } else {
            map.setView([lat, lng], 14);
        }

        if (userMarker) {
            userMarker.setLatLng([lat, lng]);
        } else {
            userMarker = L.marker([lat, lng], {title: 'You are here'}).addTo(map);
        }
    }

    function clearFacilities() {
        facilityMarkers.forEach(m => map.removeLayer(m));
        facilityMarkers = [];
        document.getElementById('facilities-list').innerHTML = '';
    }

    function loadFacilities(lat, lng) {
        const statusEl = document.getElementById('status');
        statusEl.textContent = 'Searching for nearby facilities...';

        fetch(`/api/facilities?lat=${lat}&lng=${lng}&radius=3000`)
            .then(r => r.json())
            .then(data => {
                clearFacilities();
                const listEl = document.getElementById('facilities-list');

                if (!data.facilities || data.facilities.length === 0) {
                    statusEl.textContent = 'No facilities found within 3 km. Try zooming out or moving the map.';
                    return;
                }

                statusEl.textContent = `Found ${data.facilities.length} facilities near you.`;

                data.facilities.forEach((f, idx) => {
                    const marker = L.marker([f.lat, f.lng]).addTo(map);
                    marker.bindPopup(`<strong>${f.name}</strong><br>${f.address || ''}`);
                    facilityMarkers.push(marker);

                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action facility-item';
                    item.innerHTML = `
                        <div class="fw-semibold">${f.name}</div>
                        <div class="text-muted">${f.amenity || 'Healthcare facility'}${f.address ? ' · ' + f.address : ''}</div>
                        <div class="mt-1">
                            <a href="https://www.openstreetmap.org/directions?to=${f.lat},${f.lng}" target="_blank" class="text-decoration-none small">Open directions</a>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        map.setView([f.lat, f.lng], 16);
                        marker.openPopup();
                    });
                    listEl.appendChild(item);
                });
            })
            .catch(err => {
                console.error('Facilities error', err);
                statusEl.textContent = 'Could not load facilities. Please try again later.';
            });
    }

    document.getElementById('use-location').addEventListener('click', () => {
        const statusEl = document.getElementById('status');
        if (!navigator.geolocation) {
            statusEl.textContent = 'Geolocation is not supported by your browser.';
            return;
        }
        statusEl.textContent = 'Detecting your location...';
        navigator.geolocation.getCurrentPosition(
            pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                initMap(lat, lng);
                loadFacilities(lat, lng);
            },
            err => {
                console.error('Geo error', err);
                statusEl.textContent = 'Could not get your location. Please allow location access and try again.';
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    });
</script>
</body>
</html>
